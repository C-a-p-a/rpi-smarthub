<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1280, height=720, initial-scale=1.0, user-scalable=no">
    <title>Aksjer - Smarthub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/detail.css">
</head>
<body>
    <style>
        .market-banner {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 0.6rem 1rem;
            margin-bottom: 1rem;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: background-color 0.3s ease;
            position: relative;
        }

        .market-banner.closed {
            background: linear-gradient(90deg, #dc2626, #b91c1c);
            color: white;
        }

        .market-banner.open {
            background: linear-gradient(90deg, #16a34a, #15803d);
            color: white;
        }

        .market-banner.premarket {
            background: linear-gradient(90deg, #d97706, #b45309);
            color: white;
        }

        .market-banner-icon {
            animation: pulse 2s infinite;
        }

        .market-banner.open .market-banner-icon {
            animation: pulse-green 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes pulse-green {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.2); }
        }

        .market-banner-time {
            position: absolute;
            right: 1rem;
            font-size: 0.8rem;
            font-weight: 500;
            opacity: 0.9;
        }
    </style>

    <div class="detail-page">
        <header class="detail-header">
            <div class="detail-header-left">
                <a href="/" class="back-button">‚Üê</a>
                <div>
                    <h1 class="detail-title">Aksjer</h1>
                    <div class="detail-subtitle">Portef√∏ljeoversikt</div>
                </div>
            </div>
            <div class="detail-header-center">
                <div id="detail-clock" class="detail-clock">--:--:--</div>
                <div id="detail-date" class="detail-date">Laster dato...</div>
            </div>
            <div class="detail-header-right">
                <div class="countdown-display">
                    <span>Tilbake om</span>
                    <span id="countdown">3:00</span>
                </div>
            </div>
        </header>

        <div class="detail-content">
            <!-- Market Status Banner -->
            <div id="market-banner" class="market-banner closed">
                <span class="market-banner-icon">‚óè</span>
                <span id="market-status-text">US MARKET STENGT</span>
                <span class="market-banner-time">New York: <span id="ny-time">--:--</span></span>
            </div>
            
            <div id="stocks-content" class="loading">Laster aksjer...</div>
        </div>
    </div>

    <script src="../js/detail-page.js"></script>
    <script>
        const API_URL = 'http://localhost:5000/stocks';

        async function fetchStocks() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                renderStocks(data);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('stocks-content').innerHTML = 
                    '<div class="empty-state">Kunne ikke laste aksjer</div>';
            }
        }

        function renderStocks(stocks) {
            const container = document.getElementById('stocks-content');

            if (!stocks || stocks.length === 0) {
                container.innerHTML = '<div class="empty-state">Ingen aksjedata tilgjengelig</div>';
                return;
            }

            // Group by category
            const indices = stocks.filter(s => s.category === 'index');
            const myStocks = stocks.filter(s => s.category === 'mine');
            const mag7 = stocks.filter(s => s.category === 'mag7');
            const funds = stocks.filter(s => s.category === 'fund');

            let html = '';

            // Market indices
            if (indices.length > 0) {
                html += `
                    <div class="detail-card">
                        <div class="detail-card-title">üìä Markedsindekser - Dagens Utvikling</div>
                        <div class="detail-grid" style="grid-template-columns: repeat(${indices.length}, 1fr);">
                `;
                for (const index of indices) {
                    html += renderStockCard(index, true);
                }
                html += '</div></div>';
            }

            // My stocks
            if (myStocks.length > 0) {
                html += `
                    <div class="detail-card">
                        <div class="detail-card-title">üíº Mine aksjer - Dagens Utvikling</div>
                        <div class="detail-grid detail-grid-4">
                `;
                for (const stock of myStocks) {
                    html += renderStockCard(stock, false);
                }
                html += '</div></div>';
            }

            // Magnificent 7
            if (mag7.length > 0) {
                html += `
                    <div class="detail-card">
                        <div class="detail-card-title">üöÄ Magnificent 7 - Dagens Utvikling</div>
                        <div class="detail-grid" style="grid-template-columns: repeat(7, 1fr);">
                `;
                for (const stock of mag7) {
                    html += renderStockCard(stock, false);
                }
                html += '</div></div>';
            }

            // Funds / ETFs
            if (funds.length > 0) {
                html += `
                    <div class="detail-card">
                        <div class="detail-card-title">üìà Fond & ETF-er</div>
                        <div class="detail-grid detail-grid-4">
                `;
                for (const stock of funds) {
                    html += renderStockCard(stock, false);
                }
                html += '</div></div>';
            }

            container.innerHTML = html;
        }

        function renderStockCard(stock, isIndex) {
            const changeClass = stock.change > 0 ? 'positive' : stock.change < 0 ? 'negative' : 'neutral';
            const changePrefix = stock.change > 0 ? '+' : '';
            
            let sessionBadge = '';
            if (stock.session === 'PM') {
                sessionBadge = '<span style="background: var(--warning); color: var(--bg-primary); padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.6rem; margin-left: 0.25rem;">PM</span>';
            } else if (stock.session === 'AH') {
                sessionBadge = '<span style="background: var(--accent); color: var(--bg-primary); padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.6rem; margin-left: 0.25rem;">AH</span>';
            }

            if (isIndex) {
                return `
                    <div class="stock-card">
                        <div class="stock-symbol">${stock.symbol}</div>
                        <div class="stock-change ${changeClass}" style="font-size: 1.75rem;">
                            ${changePrefix}${stock.change.toFixed(2)}%
                        </div>
                    </div>
                `;
            }

            return `
                <div class="stock-card">
                    <div class="stock-symbol">${stock.symbol}${sessionBadge}</div>
                    <div class="stock-price">$${stock.price.toFixed(2)}</div>
                    <div class="stock-change ${changeClass}">
                        ${changePrefix}${stock.change.toFixed(2)}%
                    </div>
                </div>
            `;
        }

        // Update market status banner
        function updateMarketBanner() {
            const banner = document.getElementById('market-banner');
            const statusText = document.getElementById('market-status-text');
            const nyTimeEl = document.getElementById('ny-time');
            
            const now = new Date();
            const nyTime = new Date().toLocaleString('en-US', { 
                timeZone: 'America/New_York', 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
            const nyHour = parseInt(new Date().toLocaleString('en-US', { 
                timeZone: 'America/New_York', 
                hour: 'numeric', 
                hour12: false 
            }));
            const nyMinute = parseInt(new Date().toLocaleString('en-US', { 
                timeZone: 'America/New_York', 
                minute: 'numeric'
            }));
            
            const dayOfWeek = new Date().toLocaleString('en-US', { 
                timeZone: 'America/New_York', 
                weekday: 'short' 
            });
            const isWeekday = !['Sat', 'Sun'].includes(dayOfWeek);
            
            // Market hours: 9:30 AM - 4:00 PM ET
            // Pre-market: 4:00 AM - 9:30 AM ET
            // After-hours: 4:00 PM - 8:00 PM ET
            const timeInMinutes = nyHour * 60 + nyMinute;
            const marketOpen = 9 * 60 + 30;  // 9:30 AM
            const marketClose = 16 * 60;      // 4:00 PM
            const preMarketStart = 4 * 60;    // 4:00 AM
            const afterHoursEnd = 20 * 60;    // 8:00 PM
            
            nyTimeEl.textContent = nyTime;
            
            if (!isWeekday) {
                banner.className = 'market-banner closed';
                statusText.textContent = 'US MARKET STENGT (HELG)';
            } else if (timeInMinutes >= marketOpen && timeInMinutes < marketClose) {
                banner.className = 'market-banner open';
                statusText.textContent = 'US MARKET √ÖPENT';
            } else if (timeInMinutes >= preMarketStart && timeInMinutes < marketOpen) {
                banner.className = 'market-banner premarket';
                statusText.textContent = 'PRE-MARKET';
            } else if (timeInMinutes >= marketClose && timeInMinutes < afterHoursEnd) {
                banner.className = 'market-banner premarket';
                statusText.textContent = 'AFTER-HOURS';
            } else {
                banner.className = 'market-banner closed';
                statusText.textContent = 'US MARKET STENGT';
            }
        }

        // Fetch and render
        fetchStocks();
        updateMarketBanner();

        // Update every 60 seconds
        setInterval(fetchStocks, 60000);
        setInterval(updateMarketBanner, 30000);
    </script>
</body>
</html>
